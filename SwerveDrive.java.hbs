// Copyright (c) FIRST and other WPILib contributors.
// Open Source Software; you can modify and/or share it under the terms of
// the WPILib BSD license file in the root directory of this project.

package frc.robot.subsystems;

import static edu.wpi.first.units.Units.*;

// Vendor Hardware Imports
{{#if (eq motorControllerType 'SparkMax')}}
import com.revrobotics.spark.SparkLowLevel.MotorType;
import com.revrobotics.spark.SparkMax;
import yams.motorcontrollers.local.SparkWrapper;
{{/if}}
{{#if (eq motorControllerType 'TalonFX')}}
import com.ctre.phoenix6.hardware.TalonFX;
import yams.motorcontrollers.local.TalonFXWrapper;
{{/if}}
{{#if (eq motorControllerType 'TalonFXS')}}
import com.ctre.phoenix6.hardware.TalonFXS;
import yams.motorcontrollers.local.TalonFXSWrapper;
{{/if}}
{{#if (eq motorControllerType 'Nova')}}
import com.thethriftybot.ThriftyNova;
import yams.motorcontrollers.remote.NovaWrapper;
{{/if}}
import com.ctre.phoenix6.hardware.CANcoder;
{{#if (eq gyroType 'Pigeon2')}}
import com.ctre.phoenix6.hardware.Pigeon2;
{{/if}}
{{#if (eq gyroType 'NavX')}}
import com.kauailabs.navx.frc.AHRS;
{{/if}}

// PathPlanner Imports
import com.pathplanner.lib.auto.AutoBuilder;
import com.pathplanner.lib.config.PIDConstants;
import com.pathplanner.lib.config.RobotConfig;
import com.pathplanner.lib.controllers.PPHolonomicDriveController;

// WPILib Imports
import edu.wpi.first.math.controller.PIDController;
import edu.wpi.first.math.geometry.Pose2d;
import edu.wpi.first.math.geometry.Rotation2d;
import edu.wpi.first.math.geometry.Translation2d;
import edu.wpi.first.math.kinematics.ChassisSpeeds;
import edu.wpi.first.math.system.plant.DCMotor;
import edu.wpi.first.units.measure.AngularVelocity;
import edu.wpi.first.units.measure.LinearVelocity;
import edu.wpi.first.wpilibj.DriverStation;
import edu.wpi.first.wpilibj.smartdashboard.Field2d;
import edu.wpi.first.wpilibj.smartdashboard.SmartDashboard;
import edu.wpi.first.wpilibj2.command.Command;
import edu.wpi.first.wpilibj2.command.SubsystemBase;
import java.io.IOException;
import java.util.function.DoubleSupplier;
import java.util.function.Supplier;
import org.json.simple.parser.ParseException;

// YAMS Imports
import yams.gearing.GearBox;
import yams.gearing.MechanismGearing;
import yams.mechanisms.config.SwerveDriveConfig;
import yams.mechanisms.config.SwerveModuleConfig;
import yams.mechanisms.swerve.SwerveDrive;
import yams.mechanisms.swerve.SwerveModule;
import yams.mechanisms.swerve.utility.SwerveInputStream;
import yams.motorcontrollers.SmartMotorController;
import yams.motorcontrollers.SmartMotorControllerConfig;

public class {{subsystemName}} extends SubsystemBase {

  private final SwerveDrive drive;
  private final Field2d field = new Field2d();

  // Max Speeds
  private AngularVelocity maximumChassisSpeedsAngularVelocity = DegreesPerSecond.of({{maxAngularSpeed}});
  private LinearVelocity maximumChassisSpeedsLinearVelocity = MetersPerSecond.of({{maxLinearSpeed}});

  /** Creates a new {{subsystemName}}. */
  public {{subsystemName}}() {
    // 1. Initialize Gyro
    {{#if (eq gyroType 'Pigeon2')}}
    Pigeon2 gyro = new Pigeon2({{gyroCanId}});
    Supplier<Rotation2d> gyroSupplier = () -> gyro.getRotation2d();
    {{/if}}
    {{#if (eq gyroType 'NavX')}}
    AHRS gyro = new AHRS();
    Supplier<Rotation2d> gyroSupplier = () -> gyro.getRotation2d();
    {{/if}}

    // 2. Initialize Modules
    {{#if (eq motorControllerType 'SparkMax')}}
    var fl = createModule(new SparkMax({{frontLeft.driveId}}, MotorType.kBrushless),
                          new SparkMax({{frontLeft.azimuthId}}, MotorType.kBrushless),
                          new CANcoder({{frontLeft.encoderId}}),
                          "FrontLeft",
                          new Translation2d(Inches.of({{frontLeft.xPos}}), Inches.of({{frontLeft.yPos}})));
                          
    var fr = createModule(new SparkMax({{frontRight.driveId}}, MotorType.kBrushless),
                          new SparkMax({{frontRight.azimuthId}}, MotorType.kBrushless),
                          new CANcoder({{frontRight.encoderId}}),
                          "FrontRight",
                          new Translation2d(Inches.of({{frontRight.xPos}}), Inches.of({{frontRight.yPos}})));
                          
    var bl = createModule(new SparkMax({{backLeft.driveId}}, MotorType.kBrushless),
                          new SparkMax({{backLeft.azimuthId}}, MotorType.kBrushless),
                          new CANcoder({{backLeft.encoderId}}),
                          "BackLeft",
                          new Translation2d(Inches.of({{backLeft.xPos}}), Inches.of({{backLeft.yPos}})));
                          
    var br = createModule(new SparkMax({{backRight.driveId}}, MotorType.kBrushless),
                          new SparkMax({{backRight.azimuthId}}, MotorType.kBrushless),
                          new CANcoder({{backRight.encoderId}}),
                          "BackRight",
                          new Translation2d(Inches.of({{backRight.xPos}}), Inches.of({{backRight.yPos}})));
    {{/if}}
    {{#if (eq motorControllerType 'TalonFX')}}
    var fl = createModule(new TalonFX({{frontLeft.driveId}}),
                          new TalonFX({{frontLeft.azimuthId}}),
                          new CANcoder({{frontLeft.encoderId}}),
                          "FrontLeft",
                          new Translation2d(Inches.of({{frontLeft.xPos}}), Inches.of({{frontLeft.yPos}})));
                          
    var fr = createModule(new TalonFX({{frontRight.driveId}}),
                          new TalonFX({{frontRight.azimuthId}}),
                          new CANcoder({{frontRight.encoderId}}),
                          "FrontRight",
                          new Translation2d(Inches.of({{frontRight.xPos}}), Inches.of({{frontRight.yPos}})));
                          
    var bl = createModule(new TalonFX({{backLeft.driveId}}),
                          new TalonFX({{backLeft.azimuthId}}),
                          new CANcoder({{backLeft.encoderId}}),
                          "BackLeft",
                          new Translation2d(Inches.of({{backLeft.xPos}}), Inches.of({{backLeft.yPos}})));
                          
    var br = createModule(new TalonFX({{backRight.driveId}}),
                          new TalonFX({{backRight.azimuthId}}),
                          new CANcoder({{backRight.encoderId}}),
                          "BackRight",
                          new Translation2d(Inches.of({{backRight.xPos}}), Inches.of({{backRight.yPos}})));
    {{/if}}
    {{#if (eq motorControllerType 'TalonFXS')}}
    var fl = createModule(new TalonFXS({{frontLeft.driveId}}),
                          new TalonFXS({{frontLeft.azimuthId}}),
                          new CANcoder({{frontLeft.encoderId}}),
                          "FrontLeft",
                          new Translation2d(Inches.of({{frontLeft.xPos}}), Inches.of({{frontLeft.yPos}})));
                          
    var fr = createModule(new TalonFXS({{frontRight.driveId}}),
                          new TalonFXS({{frontRight.azimuthId}}),
                          new CANcoder({{frontRight.encoderId}}),
                          "FrontRight",
                          new Translation2d(Inches.of({{frontRight.xPos}}), Inches.of({{frontRight.yPos}})));
                          
    var bl = createModule(new TalonFXS({{backLeft.driveId}}),
                          new TalonFXS({{backLeft.azimuthId}}),
                          new CANcoder({{backLeft.encoderId}}),
                          "BackLeft",
                          new Translation2d(Inches.of({{backLeft.xPos}}), Inches.of({{backLeft.yPos}})));
                          
    var br = createModule(new TalonFXS({{backRight.driveId}}),
                          new TalonFXS({{backRight.azimuthId}}),
                          new CANcoder({{backRight.encoderId}}),
                          "BackRight",
                          new Translation2d(Inches.of({{backRight.xPos}}), Inches.of({{backRight.yPos}})));
    {{/if}}
    {{#if (eq motorControllerType 'Nova')}}
    var fl = createModule(new ThriftyNova({{frontLeft.driveId}}),
                          new ThriftyNova({{frontLeft.azimuthId}}),
                          new CANcoder({{frontLeft.encoderId}}),
                          "FrontLeft",
                          new Translation2d(Inches.of({{frontLeft.xPos}}), Inches.of({{frontLeft.yPos}})));
                          
    var fr = createModule(new ThriftyNova({{frontRight.driveId}}),
                          new ThriftyNova({{frontRight.azimuthId}}),
                          new CANcoder({{frontRight.encoderId}}),
                          "FrontRight",
                          new Translation2d(Inches.of({{frontRight.xPos}}), Inches.of({{frontRight.yPos}})));
                          
    var bl = createModule(new ThriftyNova({{backLeft.driveId}}),
                          new ThriftyNova({{backLeft.azimuthId}}),
                          new CANcoder({{backLeft.encoderId}}),
                          "BackLeft",
                          new Translation2d(Inches.of({{backLeft.xPos}}), Inches.of({{backLeft.yPos}})));
                          
    var br = createModule(new ThriftyNova({{backRight.driveId}}),
                          new ThriftyNova({{backRight.azimuthId}}),
                          new CANcoder({{backRight.encoderId}}),
                          "BackRight",
                          new Translation2d(Inches.of({{backRight.xPos}}), Inches.of({{backRight.yPos}})));
    {{/if}}

    // 3. Configure Swerve Drive
    SwerveDriveConfig config = new SwerveDriveConfig(this, fl, fr, bl, br)
        .withGyro(gyroSupplier)
        .withStartingPose(new Pose2d(0, 0, Rotation2d.fromDegrees(0)))
        .withTranslationController(new PIDController({{translationPid.kP}}, {{translationPid.kI}}, {{translationPid.kD}}))
        .withRotationController(new PIDController({{rotationPid.kP}}, {{rotationPid.kI}}, {{rotationPid.kD}}));
        
    drive = new SwerveDrive(config);

    SmartDashboard.putData("Field", field);
    
    // 4. Setup PathPlanner
    try {
      setupPathPlanner();
    } catch (Exception e) {
      e.printStackTrace();
    }
  }

  /**
   * Helper to create a Swerve Module with configurations.
   */
  {{#if (eq motorControllerType 'SparkMax')}}
  public SwerveModule createModule(SparkMax drive, SparkMax azimuth, CANcoder absoluteEncoder, String moduleName, Translation2d location) {
  {{/if}}
  {{#if (eq motorControllerType 'TalonFX')}}
  public SwerveModule createModule(TalonFX drive, TalonFX azimuth, CANcoder absoluteEncoder, String moduleName, Translation2d location) {
  {{/if}}
  {{#if (eq motorControllerType 'TalonFXS')}}
  public SwerveModule createModule(TalonFXS drive, TalonFXS azimuth, CANcoder absoluteEncoder, String moduleName, Translation2d location) {
  {{/if}}
  {{#if (eq motorControllerType 'Nova')}}
  public SwerveModule createModule(ThriftyNova drive, ThriftyNova azimuth, CANcoder absoluteEncoder, String moduleName, Translation2d location) {
  {{/if}}
  
    // Drive Motor Configuration
    MechanismGearing driveGearing = new MechanismGearing(GearBox.fromStages({{driveGearingStages}}));
    SmartMotorControllerConfig driveCfg = new SmartMotorControllerConfig(this)
        .withWheelDiameter(Inches.of({{wheelDiameter}}))
        .withClosedLoopController({{drivePid.kP}}, {{drivePid.kI}}, {{drivePid.kD}})
        .withGearing(driveGearing)
        .withStatorCurrentLimit(Amps.of({{driveCurrentLimit}}))
        .withTelemetry("driveMotor", SmartMotorControllerConfig.TelemetryVerbosity.HIGH);

    // Azimuth (Steering) Motor Configuration
    MechanismGearing azimuthGearing = new MechanismGearing(GearBox.fromStages({{azimuthGearingStages}}));
    SmartMotorControllerConfig azimuthCfg = new SmartMotorControllerConfig(this)
        .withClosedLoopController({{azimuthPid.kP}}, {{azimuthPid.kI}}, {{azimuthPid.kD}})
        .withContinuousWrapping(Radians.of(-Math.PI), Radians.of(Math.PI))
        .withGearing(azimuthGearing)
        .withStatorCurrentLimit(Amps.of({{azimuthCurrentLimit}}))
        .withTelemetry("angleMotor", SmartMotorControllerConfig.TelemetryVerbosity.HIGH);

    // Create Smart Motor Controllers
    {{#if (eq motorControllerType 'SparkMax')}}
    SmartMotorController driveSMC = new SparkWrapper(drive, DCMotor.get{{motorModel}}(1), driveCfg);
    SmartMotorController azimuthSMC = new SparkWrapper(azimuth, DCMotor.get{{motorModel}}(1), azimuthCfg);
    {{/if}}
    {{#if (eq motorControllerType 'TalonFX')}}
    SmartMotorController driveSMC = new TalonFXWrapper(drive, DCMotor.get{{motorModel}}(1), driveCfg);
    SmartMotorController azimuthSMC = new TalonFXWrapper(azimuth, DCMotor.get{{motorModel}}(1), azimuthCfg);
    {{/if}}
    {{#if (eq motorControllerType 'TalonFXS')}}
    SmartMotorController driveSMC = new TalonFXSWrapper(drive, DCMotor.get{{motorModel}}(1), driveCfg);
    SmartMotorController azimuthSMC = new TalonFXSWrapper(azimuth, DCMotor.get{{motorModel}}(1), azimuthCfg);
    {{/if}}
    {{#if (eq motorControllerType 'Nova')}}
    SmartMotorController driveSMC = new NovaWrapper(drive, DCMotor.get{{motorModel}}(1), driveCfg);
    SmartMotorController azimuthSMC = new NovaWrapper(azimuth, DCMotor.get{{motorModel}}(1), azimuthCfg);
    {{/if}}

    // Create Module
    SwerveModuleConfig moduleConfig = new SwerveModuleConfig(driveSMC, azimuthSMC)
        .withAbsoluteEncoder(absoluteEncoder.getAbsolutePosition().asSupplier())
        .withTelemetry(moduleName, SmartMotorControllerConfig.TelemetryVerbosity.HIGH)
        .withLocation(location)
        .withOptimization(true);
        
    return new SwerveModule(moduleConfig);
  }

  // ... rest of the standard swerve drive methods ...

  // [Include standard methods like setupPathPlanner, getChassisSpeedsSupplier, etc. here]
  private void setupPathPlanner() throws IOException, ParseException {
    AutoBuilder.configure(
        drive::getPose, 
        drive::resetOdometry, 
        drive::getRobotRelativeSpeed, 
        (speedsRobotRelative, moduleFeedForwards) -> {
          drive.setRobotRelativeChassisSpeeds(speedsRobotRelative);
        }, 
        new PPHolonomicDriveController(
            new PIDConstants({{ppTranslationPid.kP}}, {{ppTranslationPid.kI}}, {{ppTranslationPid.kD}}), 
            new PIDConstants({{ppRotationPid.kP}}, {{ppRotationPid.kI}}, {{ppRotationPid.kD}})
        ), 
        RobotConfig.fromGUISettings(), 
        () -> {
          var alliance = DriverStation.getAlliance();
          return alliance.filter(value -> value == DriverStation.Alliance.Red).isPresent();
        }, 
        this
    );
  }

  public SwerveInputStream getChassisSpeedsSupplier(DoubleSupplier translationXScalar, DoubleSupplier translationYScalar, DoubleSupplier rotationScalar) {
    return new SwerveInputStream(drive, translationXScalar, translationYScalar, rotationScalar)
        .withMaximumAngularVelocity(maximumChassisSpeedsAngularVelocity)
        .withMaximumLinearVelocity(maximumChassisSpeedsLinearVelocity)
        .withDeadband(0.01)
        .withCubeRotationControllerAxis()
        .withCubeTranslationControllerAxis()
        .withAllianceRelativeControl();
  }
  
  public Supplier<ChassisSpeeds> getSimpleChassisSpeeds(DoubleSupplier translationXScalar, DoubleSupplier translationYScalar, DoubleSupplier rotationScalar) {
    return () -> new ChassisSpeeds(
        maximumChassisSpeedsLinearVelocity.times(translationXScalar.getAsDouble()).in(MetersPerSecond),
        maximumChassisSpeedsLinearVelocity.times(translationYScalar.getAsDouble()).in(MetersPerSecond),
        maximumChassisSpeedsAngularVelocity.times(rotationScalar.getAsDouble()).in(RadiansPerSecond));
  }

  public Command drive(Supplier<ChassisSpeeds> speedsSupplier) { return drive.drive(speedsSupplier); }
  public Command setRobotRelativeChassisSpeeds(ChassisSpeeds speeds) { return run(() -> drive.setRobotRelativeChassisSpeeds(speeds)); }
  public Command driveToPose(Pose2d pose) { return drive.driveToPose(pose); }
  public Command lock() { return run(drive::lockPose); }
  @Override public void periodic() { drive.updateTelemetry(); field.setRobotPose(drive.getPose()); }
  @Override public void simulationPeriodic() { drive.simIterate(); }
}